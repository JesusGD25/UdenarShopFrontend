<div class="product-form-container">
  <h2>{{ isEditMode ? 'Editar Producto' : 'Agregar Nuevo Producto' }}</h2>

  @if (error) {
    <div class="alert alert-error">
      {{ error }}
    </div>
  }

  @if (aiSuccess) {
    <div class="alert alert-success">
      {{ aiSuccess }}
    </div>
  }

  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form">
    <!-- T√≠tulo -->
    <div class="form-group">
      <label for="title">T√≠tulo del producto *</label>
      <input
        type="text"
        id="title"
        formControlName="title"
        placeholder="Ej: iPhone 14 Pro Max 256GB"
        [class.error]="title?.invalid && title?.touched"
      />
      @if (title?.invalid && title?.touched) {
        <span class="error-message">
          @if (title?.errors?.['required']) {
            El t√≠tulo es requerido
          }
          @if (title?.errors?.['minlength']) {
            M√≠nimo 3 caracteres
          }
          @if (title?.errors?.['maxlength']) {
            M√°ximo 200 caracteres
          }
        </span>
      }
    </div>

    <!-- Descripci√≥n -->
    <div class="form-group">
      <div class="label-with-action">
        <label for="description">Descripci√≥n</label>
        <button
          type="button"
          (click)="generateWithAi()"
          class="btn-ai"
          [disabled]="isGeneratingWithAi || !title?.value || title?.value.trim().length < 3"
          title="Generar o mejorar descripci√≥n con IA"
        >
          @if (isGeneratingWithAi) {
            <span class="ai-loading">‚ú® Generando...</span>
          } @else {
            <span>
              ‚ú® Generar con IA
              @if (hasUploadedImages) {
                <small style="display: block; font-size: 0.75rem; opacity: 0.9; margin-top: 2px;">
                  üì∏ Analizar√° las im√°genes
                </small>
              }
            </span>
          }
        </button>
      </div>
      <textarea
        id="description"
        formControlName="description"
        rows="4"
        placeholder="Describe tu producto... o usa IA para generarla autom√°ticamente"
        [class.error]="description?.invalid && description?.touched"
      ></textarea>
      @if (description?.invalid && description?.touched) {
        <span class="error-message">
          @if (description?.errors?.['maxlength']) {
            M√°ximo 2000 caracteres
          }
        </span>
      }
    </div>

    <!-- Precio y Stock en fila -->
    <div class="form-row">
      <div class="form-group">
        <label for="price">Precio (COP) *</label>
        <input
          type="number"
          id="price"
          formControlName="price"
          placeholder="Ej: 3500000"
          [class.error]="price?.invalid && price?.touched"
        />
        @if (price?.invalid && price?.touched) {
          <span class="error-message">
            @if (price?.errors?.['required']) {
              El precio es requerido
            }
            @if (price?.errors?.['min']) {
              Precio m√≠nimo: $1.000 COP
            }
            @if (price?.errors?.['max']) {
              Precio m√°ximo: $999.999.999 COP
            }
          </span>
        }
      </div>

      <div class="form-group">
        <label for="stock">Stock *</label>
        <input
          type="number"
          id="stock"
          formControlName="stock"
          placeholder="Ej: 5"
          [class.error]="stock?.invalid && stock?.touched"
        />
        @if (stock?.invalid && stock?.touched) {
          <span class="error-message">
            @if (stock?.errors?.['required']) {
              El stock es requerido
            }
            @if (stock?.errors?.['min']) {
              Stock m√≠nimo: 0
            }
            @if (stock?.errors?.['max']) {
              Stock m√°ximo: 10.000
            }
          </span>
        }
      </div>
    </div>

    <!-- Condici√≥n y Categor√≠a en fila -->
    <div class="form-row">
      <div class="form-group">
        <label for="condition">Condici√≥n</label>
        <select id="condition" formControlName="condition">
          @for (option of conditionOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label for="categoryId">Categor√≠a *</label>
        <select
          id="categoryId"
          formControlName="categoryId"
          [class.error]="categoryId?.invalid && categoryId?.touched"
        >
          <option value="">Seleccionar categor√≠a</option>
          @for (category of categories; track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
          }
        </select>
        @if (categoryId?.invalid && categoryId?.touched) {
          <span class="error-message">
            La categor√≠a es requerida
          </span>
        }
      </div>
    </div>

    <!-- Im√°genes -->
    <div class="form-group">
      <label>Im√°genes del producto * (m√°ximo 5)</label>
      
      <!-- Bot√≥n para seleccionar archivos -->
      <div class="file-upload-container">
        <input
          type="file"
          #fileInput
          accept="image/*"
          multiple
          (change)="onFileSelected($event)"
          style="display: none"
        />
        <button
          type="button"
          (click)="fileInput.click()"
          class="btn-upload"
          [disabled]="isUploadingImages || images.length >= 5"
        >
          @if (isUploadingImages) {
            <span>‚è≥ Subiendo...</span>
          } @else {
            <span>üìÅ Seleccionar Im√°genes</span>
          }
        </button>
        <small class="upload-hint">
          JPG, PNG, GIF o WebP ‚Ä¢ M√°ximo 5MB por imagen ‚Ä¢ M√≠nimo 1 imagen requerida
        </small>
      </div>

      <!-- Lista de im√°genes -->
      @if (images.length > 0) {
        <div class="images-list">
          @for (image of images; track $index) {
            <div class="image-item">
              <img [src]="image" [alt]="'Imagen ' + ($index + 1)" />
              <button
                type="button"
                (click)="removeImage($index)"
                class="btn-remove-image"
                title="Eliminar imagen"
                [disabled]="isUploadingImages"
              >
                √ó
              </button>
            </div>
          }
        </div>
      } @else {
        <div class="no-images-warning">
          ‚ö†Ô∏è Debes subir al menos una imagen del producto
        </div>
      }
    </div>

    <!-- Botones -->
    <div class="form-actions">
      <button type="button" (click)="onCancel()" class="btn btn-secondary">
        Cancelar
      </button>
      <button
        type="submit"
        [disabled]="productForm.invalid || isLoading"
        class="btn btn-primary"
      >
        {{ isEditMode ? 'Actualizar' : 'Crear' }} Producto
      </button>
    </div>
  </form>
</div>
